{% extends 'base.html' %}

{% block content %}
<h2>Randevu Yönetim Paneli</h2>
<p class="text-muted">Alınmış randevuları listele, filtrele ve yönet.</p>
<hr>

<form class="row g-2 align-items-end mb-3" method="get">
  <div class="col-auto">
    <label class="form-label">Durum</label>
    <select name="durum" class="form-select">
      <option value="">Hepsi</option>
      <option value="beklemede" {% if durum == 'beklemede' %}selected{% endif %}>Beklemede</option>
      <option value="onaylandi" {% if durum == 'onaylandi' %}selected{% endif %}>Onaylandı</option>
      <option value="gelinmedi" {% if durum == 'gelinmedi' %}selected{% endif %}>Gelinmedi</option>
      <option value="tamamlandi" {% if durum == 'tamamlandi' %}selected{% endif %}>Tamamlandı</option>
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label">Başlangıç</label>
    <input type="date" class="form-control" name="start" value="{{ start }}">
  </div>
  <div class="col-auto">
    <label class="form-label">Bitiş</label>
    <input type="date" class="form-control" name="end" value="{{ end }}">
  </div>
  <div class="col-auto">
    <label class="form-label">Temsilci</label>
    <input type="text" class="form-control" name="q_temsilci" placeholder="ad/soyad/kullanıcı adı" value="{{ q_temsilci }}">
  </div>
  <div class="col-auto">
    <label class="form-label">Firma</label>
    <input type="text" class="form-control" name="q_firma" placeholder="firma adı" value="{{ q_firma }}">
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-primary" type="submit">Filtrele</button>
    <a class="btn btn-outline-secondary" href="{% url 'yonetim_paneli' %}">Sıfırla</a>
  </div>
</form>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}

<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Tarih ve Saat</th>
        <th>Temsilci</th>
        <th>Firma</th>
        <th>Durum</th>
        <th class="text-end">İşlemler</th>
      </tr>
    </thead>
    <tbody>
      {% for r in randevular %}
      <tr>
        <td><a href="{% url 'randevu_detay' r.id %}">{{ r.tarih_saat|date:"d M Y, H:i" }}</a></td>
        <td>{{ r.temsilci.first_name }} {{ r.temsilci.last_name }} ({{ r.temsilci.username }})</td>
        <td>{{ r.temsilci.temsilciprofili.firma.ad|default:"-" }}</td>
        <td>
          {% if r.status == 'onaylandi' %}
            <span class="badge bg-success">Onaylandı</span>
          {% elif r.status == 'beklemede' %}
            <span class="badge bg-warning text-dark">Onay Bekliyor</span>
          {% elif r.status == 'tamamlandi' %}
            <span class="badge bg-info">Tamamlandı</span>
          {% elif r.status == 'gelinmedi' %}
            <span class="badge bg-secondary">Gelinmedi</span>
          {% endif %}
        </td>
        <td class="text-end">
          {% if r.status == 'onaylandi' %}
            <a href="{% url 'yonetim_randevu_tamamla' r.id %}" class="btn btn-info btn-sm">Tamamlandı</a>
          {% endif %}
          {% if r.status == 'beklemede' %}
            <a href="{% url 'yonetim_randevu_onayla' r.id %}" class="btn btn-success btn-sm">Onayla</a>
          {% endif %}
          {% if r.status == 'beklemede' or r.status == 'onaylandi' %}
            <a href="{% url 'yonetim_randevu_iptal' r.id %}" class="btn btn-danger btn-sm">İptal Et</a>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5" class="text-center">Kayıt yok.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav aria-label="Sayfalama" class="mt-3">
  <ul class="pagination">
    {% if randevular.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?durum={{ durum }}&start={{ start }}&end={{ end }}&q_temsilci={{ q_temsilci }}&q_firma={{ q_firma }}&page={{ randevular.previous_page_number }}">Önceki</a>
      </li>
    {% endif %}
    <li class="page-item disabled">
      <span class="page-link">Sayfa {{ randevular.number }} / {{ randevular.paginator.num_pages }}</span>
    </li>
    {% if randevular.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?durum={{ durum }}&start={{ start }}&end={{ end }}&q_temsilci={{ q_temsilci }}&q_firma={{ q_firma }}&page={{ randevular.next_page_number }}">Sonraki</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endblock %}
